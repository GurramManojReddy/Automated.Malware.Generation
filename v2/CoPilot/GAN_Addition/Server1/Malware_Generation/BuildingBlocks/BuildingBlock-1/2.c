#include <windows.h>
#include <stdio.h>

BOOL Debugger_Identification()
{
    BOOL bIsDebuggerPresent = FALSE;
    HANDLE hProcess = GetCurrentProcess();
    HANDLE hDuplicate = NULL;
    HANDLE hToken = NULL;
    HANDLE hTokenToCheck = NULL;
    if(!OpenProcessToken(hProcess, TOKEN_DUPLICATE, &hToken))
    {
        printf("OpenProcessToken() failed, Error = %d\n", GetLastError());
        return FALSE;
    }
    if(!DuplicateToken(hToken, SecurityImpersonation, &hDuplicate))
    {
        printf("DuplicateToken() failed, Error = %d\n", GetLastError());
        return FALSE;
    }
    SECURITY_IMPERSONATION_LEVEL securityLevel = SecurityImpersonation;
    if(!ImpersonateLoggedOnUser(hDuplicate))
    {
        printf("ImpersonateLoggedOnUser() failed, Error = %d\n", GetLastError());
        return FALSE;
    }
    if(!OpenThreadToken(GetCurrentThread(), TOKEN_QUERY, FALSE, &hTokenToCheck))
    {
        printf("OpenThreadToken() failed, Error = %d\n", GetLastError());
        return FALSE;
    }
    if(!CheckTokenMembership(hTokenToCheck, (PSID) SECURITY_NT_AUTHORITY, &bIsDebuggerPresent))
    {
        printf("CheckTokenMembership() failed, Error = %d\n", GetLastError());
        return FALSE;
    }
    CloseHandle(hProcess);
    CloseHandle(hDuplicate);
    CloseHandle(hToken);
    CloseHandle(hTokenToCheck);
    return bIsDebuggerPresent;
}